---
title: "Create Validation Data from CDL & NEI & NASS"
author: "Kenneth Qin"
date: "`r format(Sys.Date())`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = "C:/Users/kqin/Documents/Remote Sensing/Remote Sensing of N/Validation Data/CDL")
```

## Background

The main barrier to successfully deploying a satellite-based monitoring system for targeted fertilizer conservation programs is the lack of sufficient ground-truthed field-scale fertilizer application data. In theory, if we could receive annual reports of yield, crop type, and nitrogen (N) fertilizer application rate from each field in the U.S., we could develop a crude N-balance prediction system that operates at the field-scale. However, this data is elusive in part because of the legitimate concern for farmers' privacy rights. A recent study from Iowa State University reported that "30% of farmers agreed that government use of remote sensing and other tools to identify issues on private land is an invasion of privacy" (Arbuckle, 2013).

In this pilot project, **we do not attempt to predict field-scale attributes using satellite remote sensing**. Instead, we attempt to predict the mean and heterogeneity of **N-balance at the county scale**.

County-scale estimates of total N fertilizer usage was made available in the EPA's National Emissions Inventory (NEI) reports for 2014; these estimates were based on outputs of the Environmental Policy Integrated Climate (EPIC) model. When combined with the Cropland Data Layer's pixel counts of each land cover type for each county, we can identify those counties where the vast majority (i.e. > 95%) of all cultivated area consists of corn/soybean, and make the assumption that all N fertilizer within the county was applied to corn acreage. Through this process we can arrive at a **mean fertilizer application rate for corn** for a subset of counties.

County-level production (and yield) data can be retrieved from the USDA National Agricultural Statistics Service (NASS) via Quick Stats.

**County-level N-balance for corn** can then be calculated through the following equation:


N.balance = N.input - N.output = N.input - Crop.Production * N.removal.rate


This simplified N-balance equation is sufficient for our purpose of generating county-level validation data for predicting corn N-balance, though we recognize that we are making the following assumptions:

* Corn stover / stubble is not removed from the field.
* The grain has the standard moisture content of 15.5%.
* The grain has a constant N concentration of 1.4%.

*See <http://www.ipni.net/article/IPNI-3296> for details on the grain N calculation.*

Once corn N-balance has been calculated for each county, we will have produced a dataset for use in validating an *a priori* model that converts vegetation indices collected through satellite remote sensing into county-level N-balance predictions.

## Analysis

Define constants, load libraries, and import data.

```{r, message=FALSE, warning=FALSE}
# Constants

SQ_METER_PER_PIXEL <- 900
SQ_METER_PER_ACRE <- 4046.86
ACRES_PER_SQ_MILE <- 640
LBS_PER_TON <- 2000
LBS_N_REMOVED_PER_BU_CORN <- 0.67

# Libraries

library(dplyr)
library(stringr)
library(reshape2)
library(ggplot2)
library(ggmap)

# Data imports

fips <- read.csv("fips_codes.csv")

CDL2014 <- read.csv("CDL_Cnty_Pixel_2014_30m.csv")

CDL.names <- read.csv("CDL_class_names.csv")
cultivated.codes <- CDL.names$CODE[which(CDL.names$CULTIVATED)]
cultivated.codes.str <- str_pad(cultivated.codes, 3, side="left", "0")
cultivated.cats <- paste("Category_", cultivated.codes.str, sep="")

Corn2014 <- read.csv("NASS_corn_county_production_2014.csv")

Fertilizer.State.2014.NASS <- read.csv("NASS_corn_nitrogen_rate_2014.csv")
Fertilizer.County.2014 <- read.csv("EPA_fertilizer_county_2014.csv")

```

### Part 1: Find counties where (nearly) all fertilizer was applied to corn

The assumption is that in counties where (nearly) the only crops are corn and soybean, (nearly) all fertilizer should have been applied to corn.

The easiest way to identify these counties is using the **Cropland Data Layer's** county pixel counts for each crop type.

Merge county pixel-count data with county FIPS-code data.

```{r}
fips$Fips <- fips$STATEFP*1000 + fips$COUNTYFP
CDL2014.m <- merge(fips, CDL2014, by="Fips")
```

Convert pixel-counts into sq. miles and acres.

```{r}
CDL2014.sqm <- CDL2014.m
CDL2014.sqm[1:nrow(CDL2014.sqm),8:ncol(CDL2014.sqm)] <- 
  CDL2014.sqm[1:nrow(CDL2014.sqm),8:ncol(CDL2014.sqm)] * SQ_METER_PER_PIXEL

CDL2014.ac <- CDL2014.sqm
CDL2014.ac[1:nrow(CDL2014.ac),8:ncol(CDL2014.ac)] <- 
  CDL2014.ac[1:nrow(CDL2014.ac),8:ncol(CDL2014.ac)] / SQ_METER_PER_ACRE
```

Calculate total area and total cultivated area in each county.

```{r}
CDL2014.ac$Total_ac <- rowSums(select(CDL2014.ac, Category_001:Category_254))
CDL2014.ac$Total_sqmi <- CDL2014.ac$Total_ac/ACRES_PER_SQ_MILE

CDL2014.ac$Total_cult_ac <- rowSums(select(CDL2014.ac, one_of(cultivated.cats)))
CDL2014.ac$Total_cult_sqmi <- CDL2014.ac$Total_cult_ac/ACRES_PER_SQ_MILE

# Ensure that cultivated area is less than total area
prop.cultivated <- CDL2014.ac$Total_cult_ac / CDL2014.ac$Total_ac
range(prop.cultivated)
```

Calculate proportion of corn+soybean out of total CULTIVATED AREA.

```{r}
CDL2014.ac.select <- select(CDL2014.ac, -(Category_001:Category_254))

CDL2014.ac.select %>%
  mutate(prop_corn = Corn_all / Total_cult_ac,
         prop_soybean = Soybeans_all / Total_cult_ac,
         prop_cornsoybean = (Corn_all + Soybeans_all) / Total_cult_ac) ->
  CDL2014.ac.select

hist(CDL2014.ac.select$prop_cornsoybean, main="Hist. of proportion of cultivated area\nconsisting of corn or soy")
```

Identify counties with over 95% of cultivated acres consisting of corn or soy.

First, what proportion of counties have over 95% of their cultivated acreage consist of corn or soy?

```{r}
# Answer: For 95% threshold, 18% of counties (N=575).
#         For 90% threshold, 26% of counties (N=813).
mean(CDL2014.ac.select$prop_cornsoybean > 0.95, na.rm=TRUE)

# Record these counties' fips codes
ind.95.cornsoy <- which(CDL2014.ac.select$prop_cornsoybean > 0.95)
cornsoy.counties.fips <- CDL2014.ac.select$Fips[ind.95.cornsoy]
```

Where are these counties?

```{r}
# Where are these counties?
CDL2014.ac.select[ind.95.cornsoy,] %>%
  group_by(STATE) %>%
  summarise(state_n = n()) %>%
  arrange(desc(state_n)) ->
  CDL.95.statecount
CDL.95.statecount
```

What else do these counties grow?

```{r, warning=FALSE}
# What are the other crops in these counties?
CDL2014.ac.select[ind.95.cornsoy,] %>%
  select(Corn_all:Lettuce_all) %>%
  summarise_each(funs(sum)) ->
  temp
ggplot(melt(temp), aes(x=variable, y=value)) + geom_bar(stat='identity') +
  theme(axis.text.x = element_text(angle=90, hjust=1)) + 
  ggtitle("Crop Acreage Distributions within High-Corn/Soy Counties")
```

Aside from corn and soybean, these counties also grow a substantial amount of winter wheat. Winter wheat removes almost twice as much N as corn, which may bias the corn N-balance downwards, but this bias will probably be balanced out by the remainder of crops taking less N than corn. Besides, these crops only make up to 5% of total acreage in these counties.


#### Checkpoint: How well does CDL data compare to NASS data? 

First create standard FIPS code within Corn data.

```{r}
Corn2014$Fips <- Corn2014$State.ANSI*1000 + Corn2014$County.ANSI
```

Reshape Corn data and calculate total corn production (in bushels) for each county.

```{r}
Corn2014.w <- dcast(Corn2014, Fips + State + County ~ Data.Item, value.var="Value", fun.aggregate = sum)

names(Corn2014.w)[4] <- "Acres.NASS"
names(Corn2014.w)[5] <- "Production.NASS"
```

Now check county total corn acres:

```{r}
CDL.NASS.m <- merge(CDL2014.ac.select, Corn2014.w)
CDL.NASS.cornsoy <- filter(CDL.NASS.m, Fips %in% cornsoy.counties.fips)

ggplot(CDL.NASS.cornsoy, aes(x=Acres.NASS, y=Corn_all)) + geom_point() + 
  geom_abline(intercept=0, slope=1) + ylab("Acres.CDL") +
  ggtitle("CDL vs. NASS estimates of county corn acreage in 2014")

```

Looks like a good fit!

### Part 2: Extract N fertilizer data from NEI 2014 for this subset of counties

How well does NEI data compare to NASS data? Check state total N fertilizer application.

Something that we may want to consider: 

* The NASS data only represents fertilizer applied to corn, so in order to make a fair comparison with EPA estimates, the EPA estimates must be filtered for high-corn/soy counties only.
* It appears that NASS state-level fertilizer estimates do **not** include organic N (e.g. manure), whereas EPA county-level fertilizer estimates do. UPDATE: This makes very little difference in overall pattern of calibration curve.

```{r}
names(Fertilizer.State.2014.NASS)[11] <- "N.lbs.per.ac.NASS"

fips.match <- match(Fertilizer.County.2014$FIPS, CDL2014.ac$Fips)
Fertilizer.County.2014$Corn.Acres <- CDL2014.ac$Corn_all[fips.match]

# Fertilizer.County.2014 %>%
#   filter(FIPS %in% cornsoy.counties.fips) %>%
#   group_by(State) %>%
#   summarise(N.lbs.per.ac.EPA = LBS_PER_TON * sum(Total.N.Fertilizer) / sum(Corn.Acres),
#             Inorganic.N.lbs.per.ac.EPA = LBS_PER_TON * sum(Urea.NH4.Fertilizer + NO3.Fertilizer) / sum(Corn.Acres),
#             N = n()) %>%
#   mutate(State = toupper(State)) ->
#   Fertilizer.State.2014.EPA

Fertilizer.County.2014 %>%
  filter(FIPS %in% cornsoy.counties.fips) %>%
  group_by(State) %>%
  summarise(Total.N.Fertilizer = LBS_PER_TON * sum(Total.N.Fertilizer),
            Total.Urea.NH4 = LBS_PER_TON * sum(Urea.NH4.Fertilizer),
            Total.NO3 = LBS_PER_TON * sum(NO3.Fertilizer),
            Total.Corn.Acres = sum(Corn.Acres),
            n = n()) %>%
  mutate(N.lbs.per.ac.EPA = Total.N.Fertilizer / Total.Corn.Acres,
         Inorganic.N.lbs.per.ac.EPA = (Total.Urea.NH4 + Total.NO3) / Total.Corn.Acres,
         State = toupper(State)) ->
  Fertilizer.CornSoyCounties.2014.EPA

# ggplot(Fertilizer.CornSoyCounties.2014.EPA, aes(x=Total.Corn.Acres, y=Total.N.Fertilizer, label=State)) +
#   geom_point() + stat_smooth(method="lm") + geom_text(vjust=1.5)

Fertilizer.State.2014.m <- merge(Fertilizer.State.2014.NASS, Fertilizer.CornSoyCounties.2014.EPA)

ggplot(Fertilizer.State.2014.m, aes(x=N.lbs.per.ac.NASS, y=N.lbs.per.ac.EPA, label=State)) +
  geom_point(aes(size=Total.Corn.Acres)) + geom_abline(intercept=0, slope=1) +
  geom_text(vjust=1.5) + ggtitle("EPA estimated N rate for high-corn/soy counties\nvs. NASS corn N rate, state aggregation")

```

Clearly the EPA estimates of N rate are in disagreement with the NASS estimates. EPA estimates are almost always higher than NASS estimates, with the exception of Minnesota rates.

It could be that farmers under-report their fertilizer application rates in NASS surveys. It could also be that the EPIC model used by the EPA in estimating fertilizer application rates is biased upward.



### Part 3: Calculate N-balance for this subset of counties

Assuming IPNI nutrient removal rate of **0.67 lbs. N / bu**, calculate county-scale N-balance (lbs. N / ac).

**NOTE: THIS ASSUMES CONSTANT CORN N REMOVAL RATE. EILEEN ONCE RECOMMENDED AN N REMOVAL RATE THAT VARIED LINEARLY WITH N INPUT.**

```{r}
Nbalance.cornsoy <- merge(CDL.NASS.cornsoy, Fertilizer.County.2014, by.x="Fips", by.y="FIPS")
Nbalance.cornsoy %>%
  mutate(Nbal = Total.N.Fertilizer - LBS_N_REMOVED_PER_BU_CORN * Production.NASS / Corn.Acres) ->
  Nbalance.cornsoy

ggplot(Nbalance.cornsoy, aes(x=Nbal)) + geom_histogram(breaks = seq(-1000,46000,1000)) +
  ggtitle("Histogram of Average Corn N-Balance for High-Corn/Soy Counties")
```

Export data for use in other platforms like Tableau:

```{r}
Nbalance.cornsoy %>%
  select(Fips, State.x, County.x, Total_cult_ac, Corn.Acres, Total.N.Fertilizer, Organic.N.Fertilizer, Urea.NH4.Fertilizer, NO3.Fertilizer, Production.NASS, Nbal) ->
  Nbalance.cornsoy.select
names(Nbalance.cornsoy.select) <- c("FIPS","STATE","COUNTY","Total_Cult_Ac","Corn_Ac","Total_N_Fertilizer","Organic_N_Fertilizer","Urea_NH4_Fertilizer","NO3_Fertilizer","Production_Bu","N_Balance")

# write.csv(Nbalance.cornsoy.select, "N_balance_highcornsoy_2014.csv", row.names=FALSE)
```

Create a map of county average N-balance values:

```{r}
# Merge county coordinates data with N-balance data
counties <- map_data("county")
counties$state_county <- paste(counties$region, counties$subregion)

Nbalance.cornsoy.select$state_county <- paste(tolower(Nbalance.cornsoy.select$STATE),
                                              tolower(Nbalance.cornsoy.select$COUNTY))

Nbalance.cornsoy.geo <- merge(counties, Nbalance.cornsoy.select)
Nbalance.cornsoy.geo <- arrange(Nbalance.cornsoy.geo, group, order)

# Retrieve base map from Google Maps
map = get_map(location = c(-87, 39), 
              zoom = 5, source = "google", maptype="terrain")
map.plot = ggmap(map)

# Create choropleth (filled) map
m1 <- map.plot + geom_path(data=Nbalance.cornsoy.geo, aes(x=long, y=lat, group=group), color="grey") + coord_equal()

m2 <- m1 + geom_polygon(data=Nbalance.cornsoy.geo, aes(x=long, y=lat, group=group, fill=N_Balance)) + 
  coord_equal() + scale_fill_continuous("N Balance (lbs.N/bu)") +
  ggtitle("Average County-Level Corn N-Balance, 2014")

m2
```